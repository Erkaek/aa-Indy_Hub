{% extends "indy_hub/base.html" %}
{% load i18n %}
{% load static %}

{% block page_title %}{% trans "Material Exchange Configuration" %}{% endblock page_title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'indy_hub/css/page_headers.css' %}">
<link rel="stylesheet" href="{% static 'indy_hub/css/components.css' %}">
<link rel="stylesheet" href="{% static 'indy_hub/css/blueprints.css' %}">
<link rel="stylesheet" href="{% static 'indy_hub/css/material_exchange_config.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header mb-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <h2 class="h3 mb-1">
                    <i class="fas fa-exchange-alt me-2"></i>
                    {% trans "Material Exchange" %}
                </h2>
                <p class="description mb-0">{% trans "Configure corp hangar location and pricing rules." %}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'indy_hub:material_exchange_index' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i>{% trans "Back to Hub" %}
                </a>
            </div>
        </div>
        <i class="fas fa-exchange-alt header-bg"></i>
    </div>

    <!-- ESI Scopes Setup -->
    <section class="dashboard-section mb-4">
        <header class="section-heading">
            <div>
                <h3 class="section-title">{% trans "ESI Scopes Setup" %}</h3>
                <p class="text-muted small mb-0">{% trans "Material Exchange requires ESI authentication with specific scopes." %}</p>
            </div>
        </header>
        <div class="card focus-card">
            <div class="card-body p-4">
                <div class="row g-3 mb-3">
                    <div class="col-lg-6">
                        <div class="d-flex gap-3 align-items-start">
                            <div class="flex-shrink-0">
                                <div class="bg-info bg-opacity-10 text-info p-3 rounded-3">
                                    <i class="fas fa-boxes fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-semibold mb-1">{% trans "Assets Scope" %}</h6>
                                <p class="small text-muted mb-0">esi-assets.read_corporation_assets.v1</p>
                                <p class="small text-muted">{% trans "Read corporation assets and structures" %}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="d-flex gap-3 align-items-start">
                            <div class="flex-shrink-0">
                                <div class="bg-success bg-opacity-10 text-success p-3 rounded-3">
                                    <i class="fas fa-sitemap fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-semibold mb-1">{% trans "Divisions Scope" %}</h6>
                                <p class="small text-muted mb-0">esi-corporations.read_divisions.v1</p>
                                <p class="small text-muted">{% trans "Read corporation hangar divisions" %}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="d-flex gap-3 align-items-start">
                            <div class="flex-shrink-0">
                                <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-3">
                                    <i class="fas fa-file-contract fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-semibold mb-1">{% trans "Contracts Scope" %}</h6>
                                <p class="small text-muted mb-0">esi-contracts.read_corporation_contracts.v1</p>
                                <p class="small text-muted">{% trans "Read corporation contracts for validation" %}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="d-flex gap-3 align-items-start">
                            <div class="flex-shrink-0">
                                <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-3">
                                    <i class="fas fa-globe fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-semibold mb-1">{% trans "Universe Scope" %}</h6>
                                <p class="small text-muted mb-0">esi-universe.read_structures.v1</p>
                                <p class="small text-muted">{% trans "Read structure names and information" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'indy_hub:material_exchange_request_all_scopes' %}" class="btn btn-success">
                        <i class="fas fa-plus-circle me-1"></i>
                        {% trans "Add All Scopes" %}
                    </a>
                </div>
            </div>
        </div>
    </section>

        {% if not available_corps %}
        <section class="dashboard-section mb-4">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {% trans "No corporations found. Make sure you have ESI tokens authorized." %}
                <a href="{% url 'indy_hub:token_management' %}" class="alert-link">{% trans "Manage Tokens" %}</a>
                {% trans "or" %}
                <a href="{% url 'indy_hub:material_exchange_request_all_scopes' %}" class="alert-link">{% trans "Add All Scopes" %}</a>
            </div>
        </section>
        {% endif %}

    {% if config %}
    <section class="dashboard-section mb-4">
        <header class="section-heading">
            <div>
                <h3 class="section-title">{% trans "Current Configuration" %}</h3>
                <p class="text-muted small mb-0">{% trans "Your active Material Exchange hub setup." %}</p>
            </div>
        </header>
        <div class="card focus-card">
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-start gap-3">
                            <div class="flex-shrink-0">
                                <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-3">
                                    <i class="fas fa-building fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted small mb-1">{% trans "Corporation" %}</p>
                                <h6 class="fw-semibold">{{ config.corporation_name }}</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-start gap-3">
                            <div class="flex-shrink-0">
                                <div class="bg-info bg-opacity-10 text-info p-3 rounded-3">
                                    <i class="fas fa-warehouse fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted small mb-1">{% trans "Structure" %}</p>
                                <h6 class="fw-semibold">{{ config.structure_name }}</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-start gap-3">
                            <div class="flex-shrink-0">
                                <div class="bg-success bg-opacity-10 text-success p-3 rounded-3">
                                    <i class="fas fa-box fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted small mb-1">{% trans "Hangar Division" %}</p>
                                <h6 class="fw-semibold">{{ config.hangar_division }}</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-start gap-3">
                            <div class="flex-shrink-0">
                                <div class="{% if config.is_active %}bg-success{% else %}bg-secondary{% endif %} bg-opacity-10 {% if config.is_active %}text-success{% else %}text-secondary{% endif %} p-3 rounded-3">
                                    <i class="fas fa-{% if config.is_active %}power-off{% else %}ban{% endif %} fa-lg"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted small mb-1">{% trans "Status" %}</p>
                                <h6 class="fw-semibold">
                                    {% if config.is_active %}
                                        <span class="badge bg-success">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{% trans "Disabled" %}</span>
                                    {% endif %}
                                </h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="dashboard-section mb-4">
        <header class="section-heading">
            <div>
                <h3 class="section-title">{% trans "Hub Configuration" %}</h3>
                <p class="text-muted small mb-0">{% trans "Select corporation, structure, and hangar division." %}</p>
            </div>
        </header>
        <div class="card focus-card">
            <div class="card-body p-4">
                <form method="post" id="configForm" onsubmit="return validateForm()">
                    {% csrf_token %}
                <!-- Corporation Selection -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{% trans "Corporation" %} <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select name="corporation_id" class="form-select" required id="corpSelect">
                                <option value="">{% trans "Select a corporation..." %}</option>
                                {% for corp in available_corps %}
                                <option value="{{ corp.id }}" {% if config and config.corporation_id == corp.id %}selected{% endif %}>
                                    [{{ corp.ticker }}] {{ corp.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="refreshAssetsBtn" title="{% trans 'Refresh corporation assets and structures' %}" disabled>
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">{% trans "Corporation owning the Material Exchange hangar" %}</small>
                        <div id="refreshStatus" class="mt-2" style="display:none;">
                            <small class="text-info d-flex align-items-center gap-2">
                                <span class="spinner-border spinner-border-sm" id="refreshSpinner"></span>
                                <span id="refreshStatusText">{% trans "Refreshing assets..." %}</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Structure Selection -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{% trans "Structure" %} <span class="text-danger">*</span></label>
                        <select name="structure_id" class="form-select" required id="structureSelect">
                            <option value="">{% trans "Select corporation first..." %}</option>
                            {% for structure in available_structures %}
                            <option value="{{ structure.id }}"
                                    data-name="{{ structure.name }}"
                                    data-flags="{{ structure.flags|join:',' }}"
                                    {% if config and config.structure_id == structure.id %}selected{% endif %}>
                                {{ structure.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="structure_name" id="structureName" value="{{ config.structure_name|default:'' }}">
                        <small class="text-muted d-block mt-2">{% trans "Structure or station where the hub is located" %}</small>
                        <div id="assetsScopeInfo" class="mt-2">
                            <small class="text-muted d-block">{% trans "Structures are listed from corporation assets" %}</small>
                            <div class="alert alert-warning mt-2 d-none" id="assetsScopeMissingNotice">
                                <small><i class="fas fa-warning me-1"></i>{% trans "Structures need esi-assets.read_corporation_assets.v1 for this corporation." %}</small>
                                <div class="mt-2 d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="assetsScopeButton" onclick="requestAssetsToken()">
                                        {% trans "Add token" %}
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="assetsScopeRefreshButton" onclick="requestTokensSync()">
                                        {% trans "Refresh tokens" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{% trans "Hangar Division" %} <span class="text-danger">*</span></label>
                        <select name="hangar_division" class="form-select" required id="hangarSelect">
                            {% for div_num, div_name in hangar_divisions.items %}
                            <option value="{{ div_num }}" {% if config and config.hangar_division == div_num %}selected{% endif %}>
                                {{ div_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-2">{% trans "Corp hangar division (1-7)" %}</small>
                        <div id="divisionScopeInfo" class="mt-2">
                            <div class="alert alert-warning d-none" id="divisionScopeMissingNotice">
                                <small><i class="fas fa-warning me-1"></i>{% trans "Division names need esi-corporations.read_divisions.v1 for this corporation." %}</small>
                                <div class="mt-2 d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="divisionScopeButton" onclick="requestDivisionsToken()">
                                        {% trans "Add token" %}
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="divisionScopeRefreshButton" onclick="requestTokensSync()">
                                        {% trans "Refresh tokens" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Rules section within form -->
                <hr class="my-4">
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <h5 class="fw-semibold mb-3">{% trans "Pricing Rules" %}</h5>
                        <p class="text-muted small mb-3">{% trans "Configure markups based on Jita prices from Fuzzwork API." %}</p>
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-lightbulb me-2"></i>
                            {% trans "Prices are dynamically based on Jita prices. You can choose whether to apply markup on Buy or Sell prices." %}
                        </div>
                    </div>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="card focus-card h-100">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-success bg-opacity-10 text-success p-2 rounded-2 me-2">
                                        <i class="fas fa-arrow-right"></i>
                                    </div>
                                    <h6 class="fw-semibold mb-0">{% trans "Sell Markup" %}</h6>
                                </div>
                                <p class="text-muted small mb-3">{% trans "Members SELL items to your hub" %}</p>
                                <label class="form-label fw-semibold">{% trans "Markup %" %}</label>
                                <div class="input-group mb-3">
                                    <input
                                        type="number"
                                        name="sell_markup_percent"
                                        class="form-control"
                                        step="0.01"
                                        min="-100"
                                        max="100"
                                        inputmode="decimal"
                                        value="{{ config.sell_markup_percent|default:'0'|floatformat:'-2' }}">
                                    <span class="input-group-text">%</span>
                                </div>
                                <label class="form-label fw-semibold">{% trans "Base Price" %}</label>
                                <select name="sell_markup_base" class="form-select mb-3">
                                    <option value="buy" {% if not config or config.sell_markup_base == 'buy' %}selected{% endif %}>
                                        {% trans "Jita Buy Price" %}
                                    </option>
                                    <option value="sell" {% if config and config.sell_markup_base == 'sell' %}selected{% endif %}>
                                        {% trans "Jita Sell Price" %}
                                    </option>
                                </select>
                                <div class="p-3 bg-body-secondary rounded-3 small">
                                    <p class="text-muted mb-2"><strong>{% trans "Example:" %}</strong></p>
                                    <ul class="text-muted mb-0 ps-3">
                                        <li>{% trans "0% on Jita Buy = members get exact Jita Buy price" %}</li>
                                        <li>{% trans "5% on Jita Buy = members get 5% less ISK per unit" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card focus-card h-100">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-danger bg-opacity-10 text-danger p-2 rounded-2 me-2">
                                        <i class="fas fa-arrow-left"></i>
                                    </div>
                                    <h6 class="fw-semibold mb-0">{% trans "Buy Markup" %}</h6>
                                </div>
                                <p class="text-muted small mb-3">{% trans "Members BUY items from your hub" %}</p>
                                <label class="form-label fw-semibold">{% trans "Markup %" %}</label>
                                <div class="input-group mb-3">
                                    <input
                                        type="number"
                                        name="buy_markup_percent"
                                        class="form-control"
                                        step="0.01"
                                        min="-100"
                                        max="1000"
                                        inputmode="decimal"
                                        value="{{ config.buy_markup_percent|default:'5'|floatformat:'-2' }}">
                                    <span class="input-group-text">%</span>
                                </div>
                                <label class="form-label fw-semibold">{% trans "Base Price" %}</label>
                                <select name="buy_markup_base" class="form-select mb-3">
                                    <option value="buy" {% if not config or config.buy_markup_base == 'buy' %}selected{% endif %}>
                                        {% trans "Jita Buy Price" %}
                                    </option>
                                    <option value="sell" {% if config and config.buy_markup_base == 'sell' %}selected{% endif %}>
                                        {% trans "Jita Sell Price" %}
                                    </option>
                                </select>
                                <div class="p-3 bg-body-secondary rounded-3 small">
                                    <p class="text-muted mb-2"><strong>{% trans "Example:" %}</strong></p>
                                    <ul class="text-muted mb-0 ps-3">
                                        <li>{% trans "-5% on Jita Sell = members pay 5% less than Jita Sell" %}</li>
                                        <li>{% trans "5% on Jita Buy = members pay 5% more than Jita Buy" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-2"></i>{% trans "Save Configuration" %}
                    </button>
                    <a href="{% url 'indy_hub:material_exchange_index' %}" class="btn btn-outline-secondary">
                        {% trans "Cancel" %}
                    </a>
                </div>
                </form>
            </div>
        </div>

        {% if config %}
        <section class="dashboard-section">
            <header class="section-heading">
                <div>
                    <h3 class="section-title">{% trans "Synchronization Status" %}</h3>
                    <p class="text-muted small mb-0">{% trans "Automatic updates of stock and pricing data." %}</p>
                </div>
            </header>
            <div class="card focus-card">
                <div class="card-body p-4">
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start gap-3">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-3">
                                        <i class="fas fa-boxes fa-lg"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-semibold mb-1">{% trans "Last Stock Sync" %}</h6>
                                    <p class="text-muted mb-0">
                                        {% if config.last_stock_sync %}
                                            <strong>{{ config.last_stock_sync|date:"Y-m-d H:i:s" }}</strong>
                                        {% else %}
                                            <span class="text-warning">{% trans "Never synced" %}</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start gap-3">
                                <div class="flex-shrink-0">
                                    <div class="bg-success bg-opacity-10 text-success p-3 rounded-3">
                                        <i class="fas fa-chart-line fa-lg"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-semibold mb-1">{% trans "Last Price Sync" %}</h6>
                                    <p class="text-muted mb-0">
                                        {% if config.last_price_sync %}
                                            <strong>{{ config.last_price_sync|date:"Y-m-d H:i:s" }}</strong>
                                        {% else %}
                                            <span class="text-warning">{% trans "Never synced" %}</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {% trans "Stock and prices are refreshed on-demand when accessing the Buy and Sell pages (if older than 1 hour)." %}
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </div>
</div>

{{ hangar_divisions|json_script:"hangarDivisionsData" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const corpSelect = document.getElementById('corpSelect');
    const structureSelect = document.getElementById('structureSelect');
    const structureName = document.getElementById('structureName');
    const hangarSelect = document.getElementById('hangarSelect');
    const submitBtn = document.getElementById('submitBtn');
    let hangarDivisions = JSON.parse(document.getElementById('hangarDivisionsData').textContent);
    let divisionScopeMissing = {{ division_scope_missing|yesno:"true,false" }};
    let assetsScopeMissing = {{ assets_scope_missing|yesno:"true,false" }};
    const divisionScopeMissingNotice = document.getElementById('divisionScopeMissingNotice');
    const assetsScopeMissingNotice = document.getElementById('assetsScopeMissingNotice');

    // Initialize scope notices based on server-rendered flags
    if (divisionScopeMissing && divisionScopeMissingNotice) {
        divisionScopeMissingNotice.classList.remove('d-none');
    }
    if (assetsScopeMissing && assetsScopeMissingNotice) {
        assetsScopeMissingNotice.classList.remove('d-none');
    }

    const updateSubmitButton = () => {
        if (hangarSelect.disabled || divisionScopeMissing) {
            submitBtn.disabled = true;
            submitBtn.title = "{% trans 'Please add a divisions token to save configuration' %}";
        } else {
            submitBtn.disabled = false;
            submitBtn.title = "";
        }
    };

    const rebuildHangarOptions = (flagsCsv) => {
        const prevValue = hangarSelect.value;

        // If scope is missing, block selection and prompt for token
        if (divisionScopeMissing) {
            hangarSelect.innerHTML = '<option value="">{% trans "Add divisions token to load hangars" %}</option>';
            hangarSelect.disabled = true;
            if (divisionScopeMissingNotice) {
                divisionScopeMissingNotice.classList.remove('d-none');
            }
            updateSubmitButton();
            return;
        }

        hangarSelect.disabled = false;
        hangarSelect.innerHTML = '';

        const flags = (flagsCsv || '').split(',').map(f => f.trim()).filter(Boolean);
        const allowedNumbers = flags
            .map(flag => flag.startsWith('CorpSAG') ? parseInt(flag.replace('CorpSAG', ''), 10) : null)
            .filter(num => Number.isInteger(num) && num >= 1 && num <= 7);

        const divisionOrder = allowedNumbers.length ? allowedNumbers : Object.keys(hangarDivisions).map(n => parseInt(n, 10)).sort((a,b) => a-b);

        divisionOrder.forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = hangarDivisions[num] || hangarDivisions[String(num)] || `Hangar Division ${num}`;
            hangarSelect.appendChild(option);
        });

        const prevNum = parseInt(prevValue, 10);
        if (divisionOrder.includes(prevNum)) {
            hangarSelect.value = prevValue;
        } else if (divisionOrder.length > 0) {
            hangarSelect.value = String(divisionOrder[0]);
        }
        updateSubmitButton();
    };

    // Update structure name when structure is selected
    structureSelect.addEventListener('change', function() {
        const selectedOption = structureSelect.options[structureSelect.selectedIndex];
        structureName.value = selectedOption.getAttribute('data-name') || '';
        rebuildHangarOptions(selectedOption.getAttribute('data-flags'));
    });

    const fetchStructures = (corpId, preserveSelection = false) => {
        const prevStructure = preserveSelection ? structureSelect.value : '';
        const prevHangar = preserveSelection ? hangarSelect.value : '';

        if (!corpId) {
            structureSelect.innerHTML = '<option value="">{% trans "Select corporation first..." %}</option>';
            rebuildHangarOptions('');
            updateSubmitButton();
            return;
        }

        structureSelect.innerHTML = '<option value="">{% trans "Loading structures..." %}</option>';
        structureSelect.disabled = true;

        fetch(`{% url 'indy_hub:material_exchange_get_structures' 0 %}`.replace('/0/', `/${corpId}/`))
            .then(response => response.json())
            .then(data => {
                structureSelect.innerHTML = '<option value="">{% trans "Select a structure..." %}</option>';

                if (data.hangar_divisions) {
                    hangarDivisions = data.hangar_divisions;
                }
                divisionScopeMissing = !!data.division_scope_missing;
                if (divisionScopeMissing) {
                    console.warn('Division names are defaulted: missing esi-corporations.read_divisions.v1 for this corp.');
                    if (divisionScopeMissingNotice) {
                        divisionScopeMissingNotice.classList.remove('d-none');
                    }
                } else if (divisionScopeMissingNotice) {
                    divisionScopeMissingNotice.classList.add('d-none');
                }

                assetsScopeMissing = !!data.assets_scope_missing;
                if (assetsScopeMissing) {
                    console.warn('Structures list may be incomplete: missing esi-assets.read_corporation_assets.v1 for this corp.');
                    if (assetsScopeMissingNotice) {
                        assetsScopeMissingNotice.classList.remove('d-none');
                    }
                } else if (assetsScopeMissingNotice) {
                    assetsScopeMissingNotice.classList.add('d-none');
                }

                data.structures.forEach(structure => {
                    const option = document.createElement('option');
                    option.value = structure.id;
                    option.textContent = structure.name;
                    option.setAttribute('data-name', structure.name);
                    option.setAttribute('data-flags', (structure.flags || []).join(','));
                    structureSelect.appendChild(option);
                });

                structureSelect.disabled = false;

                // Restore previous structure if still available, else pick first
                let selectedIndex = 1;
                if (prevStructure) {
                    const foundIndex = Array.from(structureSelect.options).findIndex(opt => opt.value === prevStructure);
                    if (foundIndex > 0) {
                        selectedIndex = foundIndex;
                    }
                }
                if (structureSelect.options.length > selectedIndex) {
                    structureSelect.selectedIndex = selectedIndex;
                    const selectedOption = structureSelect.options[selectedIndex];
                    structureName.value = selectedOption.getAttribute('data-name') || '';
                    rebuildHangarOptions(selectedOption.getAttribute('data-flags'));
                    if (prevHangar) {
                        hangarSelect.value = prevHangar;
                    }
                } else {
                    rebuildHangarOptions('');
                }
                updateSubmitButton();
            })
            .catch(error => {
                console.error('Error fetching structures:', error);
                structureSelect.innerHTML = '<option value="">{% trans "Error loading structures" %}</option>';
                structureSelect.disabled = false;
                rebuildHangarOptions('');
                updateSubmitButton();
            });
    };

    corpSelect.addEventListener('change', function() {
        fetchStructures(corpSelect.value, false);
    });

    // On load, fetch structures (and divisions) for the preselected corp to hydrate names
    if (corpSelect.value) {
        fetchStructures(corpSelect.value, true);
    } else if (structureSelect.value) {
        const selectedOption = structureSelect.options[structureSelect.selectedIndex];
        rebuildHangarOptions(selectedOption.getAttribute('data-flags'));
    }

    updateSubmitButton();
});

function validateForm() {
    const hangarSelect = document.getElementById('hangarSelect');
    const submitBtn = document.getElementById('submitBtn');

    if (hangarSelect.disabled || !hangarSelect.value) {
        alert('{% trans "Please add a divisions token and select a hangar division before saving." %}');
        return false;
    }
    return true;
}

function requestDivisionsToken() {
    // Redirect to corporation authorization (includes divisions/roles)
    window.location.href = '{% url "indy_hub:authorize_corp_all" %}';
}

function requestAssetsToken() {
    // Redirect to Material Exchange authorization (corp scopes incl. assets)
    window.location.href = '{% url "indy_hub:authorize_material_exchange" %}';
}

function requestTokensSync() {
    // Trigger token sync to refresh validity and scopes, then return
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "indy_hub:sync_all_tokens" %}';

    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.appendChild(csrf);
    document.body.appendChild(form);
    form.submit();
}

// Handle corporation selection and asset refresh
document.addEventListener('DOMContentLoaded', function() {
    const corpSelect = document.getElementById('corpSelect');
    const refreshBtn = document.getElementById('refreshAssetsBtn');
    const refreshStatus = document.getElementById('refreshStatus');
    const refreshStatusText = document.getElementById('refreshStatusText');
    const structureSelect = document.getElementById('structureSelect');

    // Enable/disable refresh button based on corp selection
    corpSelect.addEventListener('change', function() {
        refreshBtn.disabled = !this.value;
    });

    // Handle refresh button click
    refreshBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const corpId = corpSelect.value;
        if (!corpId) return;

        refreshBtn.disabled = true;
        refreshStatus.style.display = 'block';
        refreshStatusText.textContent = '{% trans "Refreshing assets..." %}';
        refreshStatusText.className = 'text-info';

        fetch('{% url "indy_hub:material_exchange_refresh_corp_assets" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ corporation_id: parseInt(corpId) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshStatusText.textContent = '{% trans "Assets refreshed! Updating structures..." %}';
                refreshStatusText.className = 'text-success';

                // Reload structures after refresh
                return fetch(`{% url "indy_hub:material_exchange_get_structures" 0 %}`.replace('/0/', '/' + corpId + '/'), {
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(r => r.json())
                .then(structData => {
                    // Update structure select
                    structureSelect.innerHTML = '<option value="">{% trans "Select a structure..." %}</option>';
                    structData.structures.forEach(struct => {
                        const option = document.createElement('option');
                        option.value = struct.id;
                        option.textContent = struct.name;
                        option.dataset.name = struct.name;
                        option.dataset.flags = (struct.flags || []).join(',');
                        structureSelect.appendChild(option);
                    });

                    refreshStatusText.textContent = '{% trans "Done! Structures loaded." %}';
                    setTimeout(() => {
                        refreshStatus.style.display = 'none';
                        refreshBtn.disabled = false;
                    }, 2000);
                });
            } else {
                throw new Error(data.error || '{% trans "Failed to refresh assets" %}');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            refreshStatusText.textContent = err.message || '{% trans "Error refreshing assets" %}';
            refreshStatusText.className = 'text-danger';
            setTimeout(() => {
                refreshStatus.style.display = 'none';
                refreshBtn.disabled = false;
            }, 3000);
        });
    });

    // Initial state
    refreshBtn.disabled = !corpSelect.value;
});

</script>
{% endblock content %}
