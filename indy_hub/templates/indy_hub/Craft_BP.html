{% extends "allianceauth/base-bs5.html" %}
{% load i18n %}
{% load static %}
{% load humanize %}

{% block page_title %}{{ bp_name }} - {% trans "Crafting Requirements" %}{% endblock page_title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'indy_hub/css/blueprints.css' %}">
<style>
/* Enhanced tree styling */
details {
  margin-bottom: 0.5rem;
  padding-left: 0.5rem;
  border-left: 2px solid #e9ecef;
}
details summary {
  list-style: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}
details summary:hover {
  background-color: #f8f9fa;
}
.summary-icon i {
  display: inline-block;
  transition: transform 0.2s ease-in-out;
}
details[open] summary .summary-icon i {
  transform: rotate(90deg);
}

/* Custom pill-style tabs */
ul.nav-pills {
  margin-bottom: 1.5rem;
}
ul.nav-pills .nav-link {
  border-radius: 1rem;
  background-color: #e9ecef;
  color: #495057;
  padding: 0.5rem 1rem;
  margin: 0 0.5rem;
  transition: background-color 0.2s, color 0.2s;
}
ul.nav-pills .nav-link.active {
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  color: #ffffff;
}
ul.nav-pills .nav-link:hover:not(.active) {
  background-color: #d1c4e9;
  color: #ffffff;
}
</style>
{% endblock extra_css %}

{% block content %}
<div class="container my-4">
    <div class="blueprint-header mb-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-3">
                {% if product_type_id %}
                <span class="blueprint-icon" style="width:64px;height:64px;">
                    <img src="https://images.evetech.net/types/{{ product_type_id }}/icon?size=64" alt="{{ bp_name }}" style="width:64px;height:64px;object-fit:cover;border-radius:12px;background:#f3f4f6;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                    <span class="fallback" style="display:none;"><i class="fas fa-industry"></i></span>
                </span>
                {% else %}
                <span class="blueprint-icon" style="width:64px;height:64px;">
                    <span class="fallback" style="display:flex;"><i class="fas fa-industry"></i></span>
                </span>
                {% endif %}
                <div>
                    <h1 class="h2 mb-1">
                        <i class="fas fa-tools me-2"></i>{{ bp_name }}
                    </h1>
                    <p class="mb-0 opacity-75">{% trans "Material requirements for blueprint production" %}</p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ request.GET.next|default:request.META.HTTP_REFERER|default:'#' }}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i>{% trans "Back" %}
                </a>
            </div>
        </div>
        <i class="fas fa-industry header-bg"></i>
    </div>
    <div class="mb-3">
      <div class="card bg-light border-light">
        <div class="card-body py-2 px-3">
          <form method="get" class="mb-0">
            <div class="input-group input-group-sm">
                <span class="input-group-text fw-bold">{% trans "Runs" %}</span>
                <input type="number" min="1" name="runs" id="runsInput" value="{{ num_runs|default:1 }}" class="form-control">
                <span class="input-group-text fw-bold">ME</span>
                <input type="number" min="0" max="10" name="me" id="meInput" value="{{ me }}" class="form-control">
                <span class="input-group-text fw-bold">TE</span>
                <input type="number" min="0" max="20" name="te" id="teInput" value="{{ te }}" class="form-control">
                <button class="btn btn-primary" type="submit"><i class="fas fa-sync-alt me-1"></i>{% trans "Update" %}</button>
            </div>
            {% if request.GET.next %}
                <input type="hidden" name="next" value="{{ request.GET.next|escape }}">
            {% endif %}
            <!-- Preserve active tab -->
            <input type="hidden" name="active_tab" id="activeTabInput" value="{{ request.GET.active_tab|default:'materials' }}">
          </form>
        </div>
      </div>
    </div>
    <div style="color: #fff; background: #c00; font-size: 2rem; font-weight: bold; text-align: center; padding: 1rem; margin-bottom: 2rem; border-radius: 0.5rem;">
    ðŸš§ IN ACTIVE DEVELOPMENT / DO NOT USE ðŸš§
    </div>
    {# Tabs to switch between required materials and full production tree #}
    <ul class="nav nav-pills nav-justified mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="materials-tab" data-bs-toggle="tab" data-bs-target="#tab-materials" type="button" role="tab">
                <i class="fas fa-cubes me-2"></i>{% trans "Required Materials" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tree-tab" data-bs-toggle="tab" data-bs-target="#tab-tree" type="button" role="tab">
                <i class="fas fa-sitemap me-2"></i>{% trans "Full Production Tree" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#tab-financial" type="button" role="tab">
                <i class="fas fa-dollar-sign me-2"></i>{% trans "Financial" %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="needed-tab" data-bs-toggle="tab" data-bs-target="#tab-needed" type="button" role="tab">
                <i class="fas fa-shopping-cart me-2"></i>{% trans "Purchase List" %}
            </button>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-materials" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-bold d-flex align-items-center justify-content-between">
                    <span><i class="fas fa-cubes me-2"></i>{% trans "Required Materials" %}</span>
                </div>
                <div class="card-body p-0">
                    {% if materials %}
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th></th>
                                <th>{% trans "Material" %}</th>
                                <th>{% trans "Quantity" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mat in materials %}
                            <tr>
                                <td style="width:48px;">
                                    <span class="blueprint-icon" style="width:40px;height:40px;">
                                        <img src="https://images.evetech.net/types/{{ mat.type_id }}/icon?size=32" alt="{{ mat.type_name }}" style="width:40px;height:40px;object-fit:cover;border-radius:8px;background:#f3f4f6;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                                        <span class="fallback" style="display:none;"><i class="fas fa-cube"></i></span>
                                    </span>
                                </td>
                                <td>{{ mat.type_name }}</td>
                                <td class="text-end" data-qty="{{ mat.quantity }}">{{ mat.quantity }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-4 text-center text-muted">{% trans "No materials found for this blueprint." %}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tab-tree" role="tabpanel">
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-info text-white fw-bold">
                    <i class="fas fa-sitemap me-2"></i>{% trans "Full Production Tree" %}
                </div>
                <div class="card-body p-0">
                    {% if materials_tree %}
                        <div class="p-3">
                            {% include "indy_hub/material_tree.html" with materials=materials_tree level=0 %}
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">{% trans "No sub-productions detected for this blueprint." %}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tab-financial" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white fw-bold d-flex align-items-center justify-content-between">
                    <span><i class="fas fa-file-invoice-dollar me-2"></i>{% trans "Invoice / Financial Analysis" %}</span>
                </div>
                <div class="card-body p-3">
                    <div class="invoice-box p-3">
                        <h4 class="mb-4 text-center text-primary"><i class="fas fa-file-invoice"></i> {% trans "Production Invoice" %}</h4>
                        <div class="table-responsive">
                        <table class="table table-hover table-bordered mb-3">
                            <thead class="table-dark">
                                <tr>
                                    <th>{% trans "Item" %}</th>
                                    <th class="text-end">{% trans "Qty" %}</th>
                                    <th class="text-end">{% trans "Unit Price" %}</th>
                                    <th class="text-end">{% trans "Line Total" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mat in materials %}
                                <tr>
                                    <td>{{ mat.type_name }}</td>
                                    <td class="text-end" data-qty="{{ mat.quantity }}">{{ mat.quantity }}</td>
                                    <td class="text-end"><input type="number" min="0" step="0.01" class="form-control form-control-sm unit-cost text-end" data-type-id="{{ mat.type_id }}" value="0"></td>
                                    <td class="text-end total-cost">0</td>
                                </tr>
                                {% endfor %}
                                <tr class="table-success fw-bold">
                                    <td>{% trans "Final Product" %}</td>
                                    <td class="text-end" data-qty="{{ final_product_qty|default:num_runs }}">{{ final_product_qty|default:num_runs }}</td>
                                    <td class="text-end"><input type="number" min="0" step="0.01" class="form-control form-control-sm sale-price-unit text-end" data-type-id="{{ product_type_id }}" value="0"></td>
                                    <td class="text-end total-revenue">0</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">{% trans "Total Cost" %}</th>
                                    <th class="text-end grand-total-cost">0</th>
                                </tr>
                                <tr>
                                    <th colspan="3" class="text-end">{% trans "Total Revenue" %}</th>
                                    <th class="text-end grand-total-rev">0</th>
                                </tr>
                                <tr>
                                    <th colspan="3" class="text-end">{% trans "Profit" %}</th>
                                    <th class="text-end profit">0 <span class="profit-pct text-muted">(0%)</span></th>
                                </tr>
                            </tfoot>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tab-needed" role="tabpanel">
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="fas fa-shopping-cart me-2"></i>{% trans "Items to Purchase" %}
                </div>
                <div class="card-body p-3">
                    <p class="text-muted">{% trans "Select which intermediate products you will buy, then click " %}<button id="compute-needed" class="btn btn-sm btn-outline-primary">{% trans "Compute List" %}</button></p>
                    <div class="table-responsive">
                        <table class="table table-striped" id="needed-table">
                            <thead>
                                <tr>
                                    <th>{% trans "Item" %}</th>
                                    <th class="text-end">{% trans "Qty" %}</th>
                                    <th class="text-end">{% trans "Unit Price" %}</th>
                                    <th class="text-end">{% trans "Line Total" %}</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-end">{% trans "Total Cost" %}</th>
                                    <th class="text-end purchase-total">0</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.blueprint-icon img').forEach(function(img) {
        img.onerror = function() {
            this.style.display = 'none';
            if (this.nextElementSibling) {
                this.nextElementSibling.style.display = 'flex';
            }
        };
    });
    // Manage collapse/expand of sub-levels
    document.querySelectorAll('.toggle-subtree').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var targetId = btn.getAttribute('data-target');
            var subtree = document.getElementById(targetId);
            var icon = btn.querySelector('i');
            if (subtree) {
                var expanded = btn.getAttribute('aria-expanded') === 'true';
                subtree.classList.toggle('show', !expanded);
                btn.setAttribute('aria-expanded', !expanded);
                if (!expanded) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                } else {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            }
        });
    });
});

// New function to format prices as 000,000,000.00 ISK
function formatPrice(num) {
    return num.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ISK';
}

/* New function to format numbers as 000,000,000.00 */
function formatNumber(num) {
    return num.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

// Live recalculation of financials
function recalcFinancials() {
    let costTotal = 0, revTotal = 0;
    document.querySelectorAll('#tab-financial tbody tr').forEach(tr => {
        const qty = parseFloat(tr.children[1].getAttribute('data-qty')) || 0;
        const costInput = tr.querySelector('.unit-cost');
        const revInput = tr.querySelector('.sale-price-unit');
        if (costInput) {
            const cost = (parseFloat(costInput.value) || 0) * qty;
            tr.querySelector('.total-cost').textContent = formatPrice(cost);
            costTotal += cost;
        }
        if (revInput) {
            const rev = (parseFloat(revInput.value) || 0) * qty;
            tr.querySelector('.total-revenue').textContent = formatPrice(rev);
            revTotal += rev;
        }
    });
    document.querySelector('.grand-total-cost').textContent = formatPrice(costTotal);
    document.querySelector('.grand-total-rev').textContent = formatPrice(revTotal);
    const profit = revTotal - costTotal;
    document.querySelector('.profit').childNodes[0].textContent = formatPrice(profit) + ' ';
    const pct = costTotal > 0 ? ((profit / costTotal * 100).toFixed(1)) : '0.0';
    document.querySelector('.profit-pct').textContent = `(${pct}%)`;
}

// Batch fetch prices from Fuzzwork
async function fetchAllPrices(typeIds) {
    try {
        const resp = await fetch(`{% url 'indy_hub:fuzzwork_price' %}?type_id=${typeIds.join(',')}`);
        return await resp.json();
    } catch (e) {
        console.error('Error fetching prices from Fuzzwork', e);
        return {};
    }
}

document.addEventListener('DOMContentLoaded', function(){
    // On change recalc
    const allInputs = Array.from(document.querySelectorAll('.unit-cost, .sale-price-unit'));
    allInputs.forEach(inp=>{
        inp.addEventListener('input', recalcFinancials);
    });
    // Batch fetch Fuzzwork prices
    let typeIds = allInputs.map(inp => inp.getAttribute('data-type-id')).filter(Boolean);
    // Forcer l'inclusion du vrai type_id du produit final (depuis le contexte Django)
    const productTypeId = '{{ product_type_id }}';
    if (productTypeId && !typeIds.includes(productTypeId)) {
        typeIds.push(productTypeId);
    }
    typeIds = [...new Set(typeIds)];
    fetchAllPrices(typeIds).then(prices => {
        // Populate all material and sale price inputs by parsing returned values
        allInputs.forEach(inp => {
            const tid = inp.getAttribute('data-type-id');
            const raw = prices[tid];
            let price = raw != null ? parseFloat(raw) : NaN;
            if (isNaN(price)) price = 0;
            inp.value = price.toFixed(2);
            if (price <= 0) {
                inp.classList.add('bg-warning', 'border-warning');
                inp.setAttribute('title', 'Price not available (Fuzzwork)');
            } else {
                inp.classList.remove('bg-warning', 'border-warning');
                inp.removeAttribute('title');
            }
        });
        // Override final product sale price using its true type_id
        if (productTypeId) {
            const rawFinal = prices[productTypeId];
            let finalPrice = rawFinal != null ? parseFloat(rawFinal) : NaN;
            if (isNaN(finalPrice)) finalPrice = 0;
            const saleInput = document.querySelector('.sale-price-unit');
            if (saleInput) {
                saleInput.value = finalPrice.toFixed(2);
                if (finalPrice <= 0) {
                    saleInput.classList.add('bg-warning', 'border-warning');
                    saleInput.setAttribute('title', 'Price not available (Fuzzwork)');
                } else {
                    saleInput.classList.remove('bg-warning', 'border-warning');
                    saleInput.removeAttribute('title');
                }
            }
        }
        // Initial calculation after fetching prices
        recalcFinancials();
    });
});

// Compute needed purchase list
document.getElementById('compute-needed').addEventListener('click', function(){
    const purchases = {};
    function traverse(summary) {
        const detail = summary.parentElement;
        const childDetails = detail.querySelectorAll(':scope > details');
        if (childDetails.length > 0) {
            // Non-leaf
            const cb = summary.querySelector('.mat-checkbox');
            if (cb && !cb.checked) {
                // User chooses to buy this intermediate product
                const tid = summary.dataset.typeId;
                const name = summary.dataset.typeName;
                const qty = parseInt(summary.dataset.qty) || 0;
                purchases[tid] = purchases[tid] || {name: name, qty: 0};
                purchases[tid].qty += qty;
            } else {
                // Produce: recurse into children
                childDetails.forEach(child => {
                    const childSum = child.querySelector('summary');
                    if (childSum) traverse(childSum);
                });
            }
        } else {
            // Leaf: always purchase raw material
            const tid = summary.dataset.typeId;
            const name = summary.dataset.typeName;
            const qty = parseInt(summary.dataset.qty) || 0;
            purchases[tid] = purchases[tid] || {name: name, qty: 0};
            purchases[tid].qty += qty;
        }
    }
    // Start from roots
    document.querySelectorAll('#tab-tree details > summary').forEach(rootSum => {
        traverse(rootSum);
    });
    // Render purchases
    const tbody = document.querySelector('#needed-table tbody');
    tbody.innerHTML = '';
    let totalCost = 0;
    // Fetch prices for purchase items
    const pIds = Object.keys(purchases);
    fetchAllPrices(pIds).then(prices => {
         let totalCost = 0;
        Object.entries(purchases).forEach(([tid, item]) => {
            const unit = parseFloat(prices[tid]) || 0;
            const line = unit * item.qty;
            totalCost += line;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td class="text-end">${formatNumber(item.qty)}</td>
                <td class="text-end">${formatPrice(unit)}</td>
                <td class="text-end">${formatPrice(line)}</td>
            `;
            tbody.appendChild(row);
        });
        document.querySelector('.purchase-total').textContent = formatPrice(totalCost);
    });
});
</script>
{% endblock extra_javascript %}
